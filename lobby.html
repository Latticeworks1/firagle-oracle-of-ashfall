<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firagle: Oracle of Ashfall - Multiplayer Lobby</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a0f0a 0%, #2d1810 50%, #4a2c1a 100%);
            color: #ff6b35;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lobby-container {
            background: rgba(0,0,0,0.8);
            padding: 2rem;
            border-radius: 10px;
            border: 2px solid #ff6b35;
            min-width: 600px;
            text-align: center;
        }
        .title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px #ff6b35;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 10px #ff6b35; }
            to { text-shadow: 0 0 20px #ff6b35, 0 0 30px #ff8c42; }
        }
        .section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #944dff;
            border-radius: 5px;
        }
        .button {
            background: linear-gradient(45deg, #ff6b35, #ff8c42);
            color: black;
            border: none;
            padding: 1rem 2rem;
            margin: 0.5rem;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #ff6b35;
        }
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .input {
            background: rgba(255,107,53,0.1);
            border: 2px solid #ff6b35;
            color: #ff6b35;
            padding: 0.8rem;
            margin: 0.5rem;
            border-radius: 5px;
            font-size: 1.1rem;
            width: 300px;
        }
        .input::placeholder {
            color: rgba(255,107,53,0.6);
        }
        .game-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        .game-item {
            background: rgba(148,77,255,0.1);
            border: 1px solid #944dff;
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status {
            margin: 1rem 0;
            min-height: 50px;
            padding: 1rem;
            background: rgba(255,107,53,0.1);
            border-radius: 5px;
            border-left: 4px solid #ff6b35;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ff6b35;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="lobby-container">
        <h1 class="title">FIRAGLE MULTIPLAYER</h1>
        
        <div class="section" id="authSection">
            <h2>Player Authentication</h2>
            <div id="authStatus">Checking authentication...</div>
            <button class="button" id="signInBtn" style="display:none;">Sign In with Puter</button>
        </div>

        <div class="section" id="lobbySection" style="display:none;">
            <h2>Game Lobby</h2>
            <div>
                <h3>Create New Game</h3>
                <input type="text" id="gameName" class="input" placeholder="Enter game name..." maxlength="50">
                <input type="text" id="mapName" class="input" placeholder="Map name (default: Ashfall)" value="Ashfall">
                <br>
                <label>
                    <input type="number" id="maxPlayers" class="input" style="width:100px;" min="2" max="8" value="4"> Max Players
                </label>
                <br>
                <button class="button" id="createGameBtn">Create Game</button>
            </div>

            <div>
                <h3>Join Existing Game</h3>
                <div class="game-list" id="gameList">
                    <div class="loading"></div>
                    Loading available games...
                </div>
                <button class="button" id="refreshGamesBtn">Refresh Games</button>
            </div>
        </div>

        <div class="status" id="statusDiv">
            Welcome to Firagle Multiplayer! Please sign in to continue.
        </div>
    </div>

    <script>
        class LobbyManager {
            constructor() {
                this.isSignedIn = false;
                this.playerData = null;
                this.games = [];
                this.init();
            }

            async init() {
                await this.checkAuth();
                this.setupEventListeners();
                if (this.isSignedIn) {
                    this.showLobby();
                    this.loadGames();
                }
            }

            async checkAuth() {
                try {
                    this.isSignedIn = await puter.auth.isSignedIn();
                    if (this.isSignedIn) {
                        this.playerData = await puter.auth.getUser();
                        document.getElementById('authStatus').innerHTML = `Welcome, ${this.playerData.username}!`;
                        document.getElementById('authSection').style.display = 'block';
                    } else {
                        document.getElementById('authStatus').innerHTML = 'Not signed in';
                        document.getElementById('signInBtn').style.display = 'inline-block';
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    document.getElementById('authStatus').innerHTML = 'Authentication error. Please try again.';
                    document.getElementById('signInBtn').style.display = 'inline-block';
                }
            }

            async signIn() {
                try {
                    this.updateStatus('Signing in...');
                    await puter.auth.signIn();
                    await this.checkAuth();
                    if (this.isSignedIn) {
                        this.showLobby();
                        this.loadGames();
                    }
                } catch (error) {
                    console.error('Sign in failed:', error);
                    this.updateStatus('Sign in failed. Please try again.');
                }
            }

            showLobby() {
                document.getElementById('lobbySection').style.display = 'block';
                this.updateStatus('Connected to lobby. Create or join a game to start playing!');
            }

            async createGame() {
                const gameName = document.getElementById('gameName').value.trim();
                const mapName = document.getElementById('mapName').value.trim() || 'Ashfall';
                const maxPlayers = parseInt(document.getElementById('maxPlayers').value) || 4;

                if (!gameName) {
                    this.updateStatus('Please enter a game name.');
                    return;
                }

                try {
                    this.updateStatus('Creating game...');
                    
                    const gameData = {
                        id: `game_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        name: gameName,
                        map: mapName,
                        maxPlayers: maxPlayers,
                        currentPlayers: 1,
                        host: this.playerData.username,
                        hostId: this.playerData.id,
                        created: new Date().toISOString(),
                        status: 'waiting',
                        players: [{
                            id: this.playerData.id,
                            username: this.playerData.username,
                            joinedAt: new Date().toISOString(),
                            isHost: true
                        }]
                    };

                    // Save game to Puter filesystem
                    const gameFilePath = `/games/${gameData.id}.json`;
                    await puter.fs.write(gameFilePath, JSON.stringify(gameData, null, 2));

                    // Create game lobby page
                    await this.createGameLobbyPage(gameData);
                    
                    this.updateStatus('Game "' + gameName + '" created successfully! Redirecting to game lobby...');
                    
                    // Redirect to game lobby
                    setTimeout(() => {
                        window.location.href = `game-lobby.html?gameId=${gameData.id}`;
                    }, 2000);

                } catch (error) {
                    console.error('Failed to create game:', error);
                    this.updateStatus('Failed to create game. Please try again.');
                }
            }

            async createGameLobbyPage(gameData) {
                const lobbyHTML = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Game Lobby: ' + gameData.name + '</title><script src="https://js.puter.com/v2/"></script><script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script><link rel="stylesheet" href="lobby-styles.css"></head><body><div class="game-lobby-container"><h1>Game: ' + gameData.name + '</h1><h2>Map: ' + gameData.map + '</h2><div id="playerList"></div><div id="gameControls"></div><div id="status"></div></div><script src="game-lobby.js"></script></body></html>';

                await puter.fs.write(`game-lobby.html`, lobbyHTML);
            }

            async loadGames() {
                try {
                    this.updateStatus('Loading available games...');
                    
                    // Create games directory if it doesn't exist
                    try {
                        await puter.fs.mkdir('/games');
                    } catch (e) {
                        // Directory might already exist
                    }

                    // List all game files
                    const gameFiles = await puter.fs.readdir('/games');
                    const games = [];

                    for (const file of gameFiles) {
                        if (file.name.endsWith('.json')) {
                            try {
                                const gameContent = await puter.fs.read(`/games/${file.name}`);
                                const gameData = JSON.parse(gameContent);
                                
                                // Only show games that are waiting for players
                                if (gameData.status === 'waiting' && gameData.currentPlayers < gameData.maxPlayers) {
                                    games.push(gameData);
                                }
                            } catch (e) {
                                console.error(`Failed to read game file ${file.name}:`, e);
                            }
                        }
                    }

                    this.games = games;
                    this.renderGameList();
                    
                    if (games.length === 0) {
                        this.updateStatus('No games available. Create one to get started!');
                    } else {
                        this.updateStatus('Found ' + games.length + ' available game(s). Select one to join!');
                    }

                } catch (error) {
                    console.error('Failed to load games:', error);
                    this.updateStatus('Failed to load games. Please try refreshing.');
                }
            }

            renderGameList() {
                const gameList = document.getElementById('gameList');
                
                if (this.games.length === 0) {
                    gameList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #944dff;">No games available</div>';
                    return;
                }

                gameList.innerHTML = this.games.map(game => 
                    '<div class="game-item"><div><strong>' + game.name + '</strong><br><small>Map: ' + game.map + ' | Players: ' + game.currentPlayers + '/' + game.maxPlayers + ' | Host: ' + game.host + '</small></div><button class="button" onclick="lobby.joinGame(\'' + game.id + '\')">Join</button></div>'
                ).join('');
            }

            async joinGame(gameId) {
                try {
                    this.updateStatus('Joining game...');
                    
                    const gameFile = `/games/${gameId}.json`;
                    const gameContent = await puter.fs.read(gameFile);
                    const gameData = JSON.parse(gameContent);

                    if (gameData.currentPlayers >= gameData.maxPlayers) {
                        this.updateStatus('Game is full!');
                        return;
                    }

                    if (gameData.players.some(p => p.id === this.playerData.id)) {
                        this.updateStatus('You are already in this game!');
                        return;
                    }

                    // Add player to game
                    gameData.players.push({
                        id: this.playerData.id,
                        username: this.playerData.username,
                        joinedAt: new Date().toISOString(),
                        isHost: false
                    });
                    gameData.currentPlayers++;

                    // Save updated game
                    await puter.fs.write(gameFile, JSON.stringify(gameData, null, 2));

                    this.updateStatus('Joined "' + gameData.name + '"! Redirecting to game lobby...');
                    
                    // Redirect to game lobby
                    setTimeout(() => {
                        window.location.href = `game-lobby.html?gameId=${gameId}`;
                    }, 1500);

                } catch (error) {
                    console.error('Failed to join game:', error);
                    this.updateStatus('Failed to join game. Please try again.');
                }
            }

            setupEventListeners() {
                document.getElementById('signInBtn').addEventListener('click', () => this.signIn());
                document.getElementById('createGameBtn').addEventListener('click', () => this.createGame());
                document.getElementById('refreshGamesBtn').addEventListener('click', () => this.loadGames());
                
                // Enter key handlers
                document.getElementById('gameName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.createGame();
                });
            }

            updateStatus(message) {
                document.getElementById('statusDiv').innerHTML = message;
                console.log('Status:', message);
            }
        }

        // Initialize lobby when page loads
        let lobby;
        window.addEventListener('DOMContentLoaded', () => {
            lobby = new LobbyManager();
        });
    </script>
</body>
</html>