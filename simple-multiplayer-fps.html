<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Simple Multiplayer FPS</title>
        <style>
            html, body, #root { height: 100%; margin: 0; background: #000; font-family: monospace; }
            .overlay { color: white; position: absolute; text-shadow: 1px 1px 2px black; user-select: none; z-index: 100; }
            #instructions { left: 10px; top: 10px; }
            #lobby { 
                top: 50%; left: 50%; transform: translate(-50%, -50%); 
                text-align: center; background: rgba(0,0,0,0.9); 
                padding: 30px; border: 2px solid #555; border-radius: 10px; 
                min-width: 300px;
            }
            #playerList { left: 10px; top: 100px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; }
            input { padding: 8px; margin: 5px; background: #222; color: white; border: 1px solid #555; border-radius: 4px; }
            button { 
                padding: 10px 20px; margin: 8px; background: #444; color: white; 
                border: 1px solid #666; cursor: pointer; border-radius: 4px; 
            }
            button:hover { background: #555; }
            button:disabled { background: #222; color: #666; cursor: not-allowed; }
            kbd { 
                display: inline-block; padding: 2px 6px; background: #f0f0f0; 
                border: 1px solid #ccc; border-radius: 3px; color: #000; 
                font-size: 0.9em; margin: 0 2px;
            }
            .error { color: #ff6666; margin: 10px 0; }
            .success { color: #66ff66; margin: 10px 0; }
            h1, h2, h3 { margin: 10px 0; }
        </style>
    </head>
    <body>
        <div id="root"></div>
        
        <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
        
        <script>
            
            // Pure Three.js multiplayer FPS - no React
            let gameState = {
                mode: 'menu', // 'menu' | 'lobby' | 'playing'
                sessionId: null,
                playerId: null,
                playerName: null,
                players: new Map(),
                isHost: false,
                connected: false,
                scene: null,
                camera: null,
                renderer: null,
                player: { position: [0, 2, 0], rotation: [0, 0, 0] },
                keys: {},
                mouse: { x: 0, y: 0 }
            };

            // Simple local storage multiplayer (no Puter for now)
            const multiplayerSystem = {
                sessions: JSON.parse(localStorage.getItem('fps_sessions') || '{}'),
                
                saveSession(sessionId, data) {
                    this.sessions[sessionId] = data;
                    localStorage.setItem('fps_sessions', JSON.stringify(this.sessions));
                },
                
                loadSession(sessionId) {
                    return this.sessions[sessionId] || null;
                },
                
                createSession(playerName) {
                    const sessionId = 'fps_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
                    const playerId = 'player_' + Date.now();
                    
                    const sessionData = {
                        id: sessionId,
                        host: playerId,
                        players: {
                            [playerId]: {
                                id: playerId,
                                name: playerName,
                                position: [0, 2, 0],
                                health: 100,
                                score: 0,
                                connected: true,
                                lastUpdate: Date.now()
                            }
                        },
                        gameState: 'lobby',
                        createdAt: Date.now()
                    };
                    
                    this.saveSession(sessionId, sessionData);
                    
                    gameState.sessionId = sessionId;
                    gameState.playerId = playerId;
                    gameState.playerName = playerName;
                    gameState.isHost = true;
                    gameState.players.set(playerId, sessionData.players[playerId]);
                    
                    return sessionId;
                },
                
                joinSession(sessionId, playerName) {
                    const sessionData = this.loadSession(sessionId);
                    if (!sessionData) {
                        throw new Error('Session not found');
                    }
                    
                    const playerId = 'player_' + Date.now();
                    sessionData.players[playerId] = {
                        id: playerId,
                        name: playerName,
                        position: [Math.random() * 4 - 2, 2, Math.random() * 4 - 2],
                        health: 100,
                        score: 0,
                        connected: true,
                        lastUpdate: Date.now()
                    };
                    
                    this.saveSession(sessionId, sessionData);
                    
                    gameState.sessionId = sessionId;
                    gameState.playerId = playerId;
                    gameState.playerName = playerName;
                    gameState.isHost = false;
                    
                    Object.values(sessionData.players).forEach(player => {
                        gameState.players.set(player.id, player);
                    });
                    
                    return sessionId;
                },
                
                updatePlayer(position, health, score) {
                    if (!gameState.sessionId || !gameState.playerId) return;
                    
                    const sessionData = this.loadSession(gameState.sessionId);
                    if (sessionData && sessionData.players[gameState.playerId]) {
                        sessionData.players[gameState.playerId].position = position;
                        sessionData.players[gameState.playerId].health = health;
                        sessionData.players[gameState.playerId].score = score;
                        sessionData.players[gameState.playerId].lastUpdate = Date.now();
                        
                        this.saveSession(gameState.sessionId, sessionData);
                    }
                },
                
                startGame() {
                    if (!gameState.isHost) return;
                    
                    const sessionData = this.loadSession(gameState.sessionId);
                    if (sessionData) {
                        sessionData.gameState = 'playing';
                        this.saveSession(gameState.sessionId, sessionData);
                        gameState.mode = 'playing';
                    }
                },
                
                sync() {
                    if (!gameState.sessionId) return;
                    
                    const sessionData = this.loadSession(gameState.sessionId);
                    if (sessionData) {
                        // Update players
                        Object.values(sessionData.players).forEach(player => {
                            if (player.id !== gameState.playerId) {
                                gameState.players.set(player.id, player);
                            }
                        });
                        
                        // Check game state
                        if (sessionData.gameState !== gameState.mode && sessionData.gameState === 'playing') {
                            gameState.mode = 'playing';
                            window.dispatchEvent(new CustomEvent('gameStateChanged'));
                        }
                    }
                }
            };

            // Start sync
            setInterval(() => multiplayerSystem.sync(), 500);

            // Pure Three.js game initialization
            function initGame() {
                const canvas = document.querySelector('canvas');
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ canvas });
                
                gameState.scene = scene;
                gameState.camera = camera;
                gameState.renderer = renderer;
                    
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x87CEEB);
                    
                // Add ground
                const groundGeometry = new THREE.PlaneGeometry(50, 50);
                const groundMaterial = new THREE.MeshBasicMaterial({ color: 0x228B22 });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                scene.add(ground);
                    
                // Add some cubes as obstacles
                for (let i = 0; i < 10; i++) {
                    const geometry = new THREE.BoxGeometry(1, 1, 1);
                    const material = new THREE.MeshBasicMaterial({ color: Math.random() * 0xffffff });
                    const cube = new THREE.Mesh(geometry, material);
                    cube.position.set(
                        Math.random() * 20 - 10,
                        0.5,
                        Math.random() * 20 - 10
                    );
                    scene.add(cube);
                }
                    
                // Camera setup
                camera.position.set(0, 2, 0);
                    
                // Input handling
                const handleKeyDown = (e) => gameState.keys[e.code] = true;
                const handleKeyUp = (e) => gameState.keys[e.code] = false;
                const handleMouseMove = (e) => {
                    if (document.pointerLockElement) {
                        gameState.mouse.x += e.movementX * 0.002;
                        gameState.mouse.y += e.movementY * 0.002;
                        gameState.mouse.y = Math.max(-Math.PI/2, Math.min(Math.PI/2, gameState.mouse.y));
                    }
                };
                    
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('keyup', handleKeyUp);
                document.addEventListener('mousemove', handleMouseMove);
                
                // Click to lock pointer
                canvas.addEventListener('click', () => {
                    canvas.requestPointerLock();
                });
                    
                // Game loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    // Player movement
                    const moveSpeed = 0.1;
                    let moved = false;
                    
                    if (gameState.keys['KeyW']) {
                        gameState.player.position[2] -= moveSpeed;
                        moved = true;
                    }
                    if (gameState.keys['KeyS']) {
                        gameState.player.position[2] += moveSpeed;
                        moved = true;
                    }
                    if (gameState.keys['KeyA']) {
                        gameState.player.position[0] -= moveSpeed;
                        moved = true;
                    }
                    if (gameState.keys['KeyD']) {
                        gameState.player.position[0] += moveSpeed;
                        moved = true;
                    }
                    
                    // Update camera
                    camera.position.set(...gameState.player.position);
                    camera.rotation.y = gameState.mouse.x;
                    camera.rotation.x = gameState.mouse.y;
                    
                    // Update multiplayer
                    if (moved && gameState.sessionId) {
                        multiplayerSystem.updatePlayer(gameState.player.position, 100, 0);
                    }
                    
                    renderer.render(scene, camera);
                };
                
                animate();
                    
            }

            
            function updateUI() {
                const instructions = document.getElementById('instructions');
                const playerList = [...gameState.players.values()].filter(p => p.id !== gameState.playerId);
                
                if (instructions) {
                    instructions.innerHTML = `
                        <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> to move<br/>
                        <kbd>Mouse</kbd> to look (click to enable)<br/>
                        ${playerList.length > 0 ? `<div style="margin-top: 10px">Players: ${playerList.map(p => p.name).join(', ')}</div>` : ''}
                    `;
                }
            }
            
            setInterval(updateUI, 200);

            // Lobby component
            function showLobby() {
                const root = document.getElementById('root');
                let playerName = '';
                let sessionId = '';
                let error = '';
                let success = '';

                const updateLobbyUI = () => {
                    const players = [...gameState.players.values()];
                    if (gameState.mode === 'playing') {
                        startGame();
                        return;
                    }
                    renderLobby(players);
                };
                
                const interval = setInterval(updateLobbyUI, 300);

                const handleCreate = () => {
                    const nameInput = document.getElementById('playerName');
                    playerName = nameInput.value;
                    
                    if (!playerName.trim()) {
                        error = 'Please enter your name';
                        renderLobby([]);
                        return;
                    }
                    
                    try {
                        const newSessionId = multiplayerSystem.createSession(playerName.trim());
                        success = `Game created! Session ID: ${newSessionId}`;
                        error = '';
                        gameState.connected = true;
                        renderLobby([]);
                    } catch (err) {
                        error = 'Failed to create game: ' + err.message;
                        renderLobby([]);
                    }
                };

                const handleJoin = () => {
                    const nameInput = document.getElementById('playerName');
                    const sessionInput = document.getElementById('sessionId');
                    playerName = nameInput.value;
                    sessionId = sessionInput.value;
                    
                    if (!playerName.trim() || !sessionId.trim()) {
                        error = 'Please enter your name and session ID';
                        renderLobby([]);
                        return;
                    }
                    
                    try {
                        multiplayerSystem.joinSession(sessionId.trim(), playerName.trim());
                        success = `Joined game: ${sessionId}`;
                        error = '';
                        gameState.connected = true;
                        renderLobby([]);
                    } catch (err) {
                        error = 'Failed to join game: ' + err.message;
                        renderLobby([]);
                    }
                };

                const handleStart = () => {
                    multiplayerSystem.startGame();
                    startGame();
                };

                const renderLobby = (players) => {
                    if (!gameState.connected) {
                        root.innerHTML = `
                            <div id="lobby" class="overlay">
                                <h2>🎮 Multiplayer FPS</h2>
                                
                                <div>
                                    <input id="playerName" type="text" placeholder="Your name" />
                                </div>
                                
                                <div>
                                    <button onclick="handleCreate()">Create Game</button>
                                </div>
                                
                                <div>
                                    <input id="sessionId" type="text" placeholder="Session ID to join" />
                                    <button onclick="handleJoin()">Join Game</button>
                                </div>
                                
                                <button onclick="showMenu()">Back</button>
                                
                                ${error ? `<div class="error">${error}</div>` : ''}
                                ${success ? `<div class="success">${success}</div>` : ''}
                            </div>
                        `;
                    } else {
                        root.innerHTML = `
                            <div id="lobby" class="overlay">
                                <h3>🎮 Game Lobby</h3>
                                <p>Session: <strong>${gameState.sessionId}</strong></p>
                                
                                <div style="margin: 15px 0">
                                    <h4>Players (${players.length}):</h4>
                                    ${players.map(player => `
                                        <div>👤 ${player.name} ${gameState.isHost ? '(Host)' : ''}</div>
                                    `).join('')}
                                </div>
                                
                                ${gameState.isHost ? '<button onclick="handleStart()">🚀 Start Game</button>' : '<p>⏳ Waiting for host to start...</p>'}
                                
                                <button onclick="showMenu()">Leave</button>
                            </div>
                        `;
                    }
                };
                
                // Make functions global
                window.handleCreate = handleCreate;
                window.handleJoin = handleJoin;
                window.handleStart = handleStart;
                
                renderLobby([]);
            }

            // Main app functions
            function showMenu() {
                gameState.mode = 'menu';
                gameState.connected = false;
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div id="lobby" class="overlay">
                        <h1>🎮 FPS Game</h1>
                        <button onclick="startSingleplayer()">Single Player</button>
                        <button onclick="showLobby()">Multiplayer</button>
                    </div>
                `;
            }
            
            function startSingleplayer() {
                gameState.mode = 'playing';
                startGame();
            }
            
            function startGame() {
                const root = document.getElementById('root');
                root.innerHTML = `
                    <canvas style="display: block"></canvas>
                    <div id="instructions" class="overlay"></div>
                    <button onclick="showMenu()" style="position: absolute; top: 10px; right: 10px; z-index: 1000;">Exit Game</button>
                `;
                initGame();
            }
            
            // Make functions global
            window.showMenu = showMenu;
            window.startSingleplayer = startSingleplayer;
            window.showLobby = showLobby;

            // Start the app
            showMenu();
        </script>
    </body>
</html>